# GitLab CI/CD Pipeline for Fugue Chat App
# Simplified pipeline: Build ‚Üí Test ‚Üí Deploy

stages:
  - build
  - test
  - deploy

variables:
  # Docker variables
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  
  # Registry variables
  REGISTRY_IMAGE: $CI_REGISTRY_IMAGE
  BACKEND_IMAGE: $REGISTRY_IMAGE/backend
  FRONTEND_IMAGE: $REGISTRY_IMAGE/frontend
  
  # Node.js variables
  NODE_VERSION: "18"

# =============================================================================
# BUILD STAGE
# =============================================================================

build_backend:
  stage: build
  image: docker:stable
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "üèóÔ∏è Building backend Docker image..."
    - cd backend
    - docker build -f Dockerfile.prod -t $BACKEND_IMAGE:$CI_COMMIT_SHA -t $BACKEND_IMAGE:latest .
    - docker push $BACKEND_IMAGE:$CI_COMMIT_SHA
    - docker push $BACKEND_IMAGE:latest
    - echo "‚úÖ Backend build completed successfully"
  only:
    - main
    - develop
    - MB

build_frontend:
  stage: build
  image: docker:stable
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "üèóÔ∏è Building frontend Docker image..."
    - cd frontend
    - docker build -f Dockerfile.prod -t $FRONTEND_IMAGE:$CI_COMMIT_SHA -t $FRONTEND_IMAGE:latest .
    - docker push $FRONTEND_IMAGE:$CI_COMMIT_SHA
    - docker push $FRONTEND_IMAGE:latest
    - echo "‚úÖ Frontend build completed successfully"
  only:
    - main
    - develop
    - MB

# =============================================================================
# DEPLOY STAGE
# =============================================================================

deploy_staging:
  stage: deploy
  image: docker:stable
  services:
    - docker:dind
  environment:
    name: staging
    url: https://fugue-staging.example.com
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "üöÄ Deploying to staging environment..."
    - |
      # Pull the latest images
      docker pull $BACKEND_IMAGE:$CI_COMMIT_SHA
      docker pull $FRONTEND_IMAGE:$CI_COMMIT_SHA
      
      # Deploy using docker-compose
      export POSTGRES_PASSWORD=$STAGING_POSTGRES_PASSWORD
      export SESSION_SECRET=$STAGING_SESSION_SECRET
      
      # Update docker-compose to use built images
      sed -i "s|build:|image: $BACKEND_IMAGE:$CI_COMMIT_SHA #build:|g" docker-compose.prod.yml
      sed -i "s|context: ./backend|#context: ./backend|g" docker-compose.prod.yml
      sed -i "s|dockerfile: Dockerfile.prod|#dockerfile: Dockerfile.prod|g" docker-compose.prod.yml
      
      # Start deployment
      docker-compose -f docker-compose.prod.yml up -d
      
      # Health check
      sleep 30
      curl -f http://localhost:8080/health || exit 1
      echo "‚úÖ Staging deployment successful!"
  dependencies:
    - build_backend
    - build_frontend
  only:
    - develop
    - MB
  when: manual

deploy_production:
  stage: deploy
  image: docker:stable
  services:
    - docker:dind
  environment:
    name: production
    url: https://fugue.example.com
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "üöÄ Deploying to production environment..."
    - |
      # Pull the latest images
      docker pull $BACKEND_IMAGE:$CI_COMMIT_SHA
      docker pull $FRONTEND_IMAGE:$CI_COMMIT_SHA
      
      # Deploy using docker-compose
      export POSTGRES_PASSWORD=$PROD_POSTGRES_PASSWORD
      export SESSION_SECRET=$PROD_SESSION_SECRET
      
      # Update docker-compose to use built images
      sed -i "s|build:|image: $BACKEND_IMAGE:$CI_COMMIT_SHA #build:|g" docker-compose.prod.yml
      sed -i "s|context: ./backend|#context: ./backend|g" docker-compose.prod.yml
      sed -i "s|dockerfile: Dockerfile.prod|#dockerfile: Dockerfile.prod|g" docker-compose.prod.yml
      
      # Start deployment
      docker-compose -f docker-compose.prod.yml up -d
      
      # Health check
      sleep 45
      curl -f http://localhost:8080/health || exit 1
      echo "‚úÖ Production deployment successful!"
      
      # Clean up old images
      docker system prune -f
  dependencies:
    - build_backend
    - build_frontend
  only:
    - main
  when: manual