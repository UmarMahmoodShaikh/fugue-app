# GitLab CI/CD Pipeline for Fugue Chat App
# Simplified pipeline: Build → Test → Deploy

stages:
  - build
  - test
  - deploy

variables:
  # Use Docker without TLS for simplicity
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend
  
  # Deploy directory on server
  DEPLOY_DIR: "/home/ubuntu/fugue-app"
  
  # Backend configuration
  BACKEND_PORT: "8080"

# =============================================================================
# BUILD STAGE
# =============================================================================

build_backend_image:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - sleep 10  # Give DinD time to start
    - docker info
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "Building backend Docker image..."
    - cd backend
    - docker build -t $BACKEND_IMAGE:$IMAGE_TAG -t $BACKEND_IMAGE:latest -f Dockerfile.prod .
    - docker push $BACKEND_IMAGE:$IMAGE_TAG
    - docker push $BACKEND_IMAGE:latest
    - echo "Backend build completed successfully"
  only:
    - main
    - develop
    - MB

build_frontend_image:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - sleep 10  # Give DinD time to start
    - docker info
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "Building frontend Docker image..."
    - cd frontend
    - docker build -t $FRONTEND_IMAGE:$IMAGE_TAG -t $FRONTEND_IMAGE:latest -f Dockerfile.prod .
    - docker push $FRONTEND_IMAGE:$IMAGE_TAG
    - docker push $FRONTEND_IMAGE:latest
    - echo "Frontend build completed successfully"
  only:
    - main
    - develop
    - MB
# =============================================================================
# TEST STAGE
# =============================================================================

test_backend:
  stage: test
  image: node:18
  needs:
    - build_backend_image
  services:
    - postgres:16-alpine
  variables:
    POSTGRES_DB: test_fugue_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_pass
    DATABASE_URL: postgresql://test_user:test_pass@postgres:5432/test_fugue_db
    NODE_ENV: test
  before_script:
    - cd backend
    - npm install
  script:
    - echo "Running backend tests..."
    - npm test
    - echo "Backend tests completed"
  only:
    - main
    - develop
    - MB

test_frontend:
  stage: test
  image: node:18
  needs:
    - build_frontend_image
  before_script:
    - cd frontend
    - npm install
  script:
    - echo "Running frontend tests..."
    - npm test
    - echo "Frontend tests completed"
  only:
    - main
    - develop
    - MB

# =============================================================================
# DEPLOY STAGE
# =============================================================================

deploy_aws_staging:
  stage: deploy
  image: alpine:latest
  needs:
    - build_backend_image
    - build_frontend_image
    - test_backend
    - test_frontend
  before_script:
    - apk add --no-cache openssh-client rsync bash docker-cli curl
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$STAGING_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
  script:
    - echo "Deploying Fugue app to AWS EC2 ($STAGING_HOST)..."
    
    # Create .env file locally with secrets from GitLab CI/CD Variables
    - |
      cat > .env <<EOF
      POSTGRES_DB=fugue_app
      POSTGRES_USER=fugue_user
      POSTGRES_PASSWORD=$POSTGRES_PASSWORD
      BACKEND_PORT=8080
      SESSION_SECRET=$SESSION_SECRET
      NODE_ENV=production
      FRONTEND_PORT=80
      EOF
    
    # Copy files to EC2
    - rsync -avz docker-compose.prod.yml "$STAGING_USER@$STAGING_HOST:$DEPLOY_DIR/docker-compose.prod.yml"
    
    # Only upload .env if it doesn't exist or credentials changed
    - |
      ssh -o StrictHostKeyChecking=no "$STAGING_USER@$STAGING_HOST" "test -f $DEPLOY_DIR/.env" || \
      rsync -avz .env "$STAGING_USER@$STAGING_HOST:$DEPLOY_DIR/.env"
    
    # Deploy to AWS EC2 instance
    - |
      ssh -o StrictHostKeyChecking=no "$STAGING_USER@$STAGING_HOST" \
        "cd $DEPLOY_DIR && \
         echo 'Logging into GitLab Container Registry...' && \
         echo '$CI_REGISTRY_PASSWORD' | docker login -u '$CI_REGISTRY_USER' --password-stdin $CI_REGISTRY && \
         export FRONTEND_IMAGE='$FRONTEND_IMAGE:$IMAGE_TAG' && \
         export BACKEND_IMAGE='$BACKEND_IMAGE:$IMAGE_TAG' && \
         echo 'Pulling latest Docker images...' && \
         docker pull \$FRONTEND_IMAGE && \
         docker pull \$BACKEND_IMAGE && \
         echo 'Stopping old containers...' && \
         docker-compose -f docker-compose.prod.yml down --timeout 30 || true && \
         echo 'Starting new containers...' && \
         docker-compose -f docker-compose.prod.yml up -d && \
         echo 'Waiting for services to start...' && \
         sleep 5 && \
         echo 'Checking if containers are running...' && \
         docker-compose -f docker-compose.prod.yml ps && \
         echo 'Testing backend health (up to 60s)...' && \
         for i in {1..12}; do \
           if curl -f http://localhost:$BACKEND_PORT/health 2>/dev/null; then \
             echo 'Backend is healthy!' && break; \
           else \
             echo \"Attempt \$i/12 failed, waiting 5s...\" && sleep 5; \
           fi; \
         done && \
         echo 'Deployment completed!'"
  environment:
    name: aws-staging
    url: http://$STAGING_HOST
  dependencies:
    - build_backend_image
    - build_frontend_image
  only:
    - MB

deploy_aws_production:
  stage: deploy
  image: alpine:latest
  needs:
    - build_backend_image
    - build_frontend_image
    - test_backend
    - test_frontend
  before_script:
    - apk add --no-cache openssh-client rsync bash docker-cli curl
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$STAGING_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
  script:
    - echo "Deploying Fugue app to AWS EC2 Production ($STAGING_HOST)..."
    
    # Create .env file locally with secrets from GitLab CI/CD Variables
    - |
      cat > .env <<EOF
      POSTGRES_DB=fugue_app
      POSTGRES_USER=fugue_user
      POSTGRES_PASSWORD=$POSTGRES_PASSWORD
      BACKEND_PORT=8080
      SESSION_SECRET=$SESSION_SECRET
      NODE_ENV=production
      FRONTEND_PORT=80
      EOF
    
    # Copy files to EC2
    - rsync -avz docker-compose.prod.yml "$STAGING_USER@$STAGING_HOST:$DEPLOY_DIR/docker-compose.prod.yml"
    
    # Only upload .env if it doesn't exist or credentials changed
    - |
      ssh -o StrictHostKeyChecking=no "$STAGING_USER@$STAGING_HOST" "test -f $DEPLOY_DIR/.env" || \
      rsync -avz .env "$STAGING_USER@$STAGING_HOST:$DEPLOY_DIR/.env"
    
    # Deploy to AWS EC2 production
    - |
      ssh -o StrictHostKeyChecking=no "$STAGING_USER@$STAGING_HOST" \
        "cd $DEPLOY_DIR && \
         echo 'Logging into GitLab Container Registry...' && \
         echo '$CI_REGISTRY_PASSWORD' | docker login -u '$CI_REGISTRY_USER' --password-stdin $CI_REGISTRY && \
         export FRONTEND_IMAGE='$FRONTEND_IMAGE:$IMAGE_TAG' && \
         export BACKEND_IMAGE='$BACKEND_IMAGE:$IMAGE_TAG' && \
         echo 'Pulling latest Docker images...' && \
         docker pull \$FRONTEND_IMAGE && \
         docker pull \$BACKEND_IMAGE && \
         echo 'Stopping old containers...' && \
         docker-compose -f docker-compose.prod.yml down --timeout 30 || true && \
         echo 'Cleaning old Docker images...' && \
         docker image prune -f && \
         echo 'Starting new containers...' && \
         docker-compose -f docker-compose.prod.yml up -d && \
         echo 'Waiting for services to start...' && \
         sleep 5 && \
         echo 'Checking if containers are running...' && \
         docker-compose -f docker-compose.prod.yml ps && \
         echo 'Testing backend health (up to 60s)...' && \
         for i in {1..12}; do \
           if curl -f http://localhost:$BACKEND_PORT/health 2>/dev/null; then \
             echo 'Backend is healthy!' && break; \
           else \
             echo \"Attempt \$i/12 failed, waiting 5s...\" && sleep 5; \
           fi; \
         done && \
         echo 'Deployment completed!'"
  environment:
    name: aws-production
    url: http://$STAGING_HOST
  dependencies:
    - build_backend_image
    - build_frontend_image
  only:
    - main