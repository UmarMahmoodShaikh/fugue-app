# GitLab CI/CD Pipeline for Fugue Chat App
# Simplified pipeline: Build ‚Üí Test ‚Üí Deploy

stages:
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend
  
  # Deploy directory on server
  DEPLOY_DIR: "/home/ubuntu/fugue-app"

# =============================================================================
# BUILD STAGE
# =============================================================================

build_backend_image:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "üê≥ Building backend Docker image..."
    - cd backend
    - docker build -t $BACKEND_IMAGE:$IMAGE_TAG -t $BACKEND_IMAGE:latest -f Dockerfile.prod .
    - docker push $BACKEND_IMAGE:$IMAGE_TAG
    - docker push $BACKEND_IMAGE:latest
    - echo "‚úÖ Backend build completed successfully"
  only:
    - main
    - develop
    - MB

build_frontend_image:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "üê≥ Building frontend Docker image..."
    - cd frontend
    - docker build -t $FRONTEND_IMAGE:$IMAGE_TAG -t $FRONTEND_IMAGE:latest -f Dockerfile.prod .
    - docker push $FRONTEND_IMAGE:$IMAGE_TAG
    - docker push $FRONTEND_IMAGE:latest
    - echo "‚úÖ Frontend build completed successfully"
  only:
    - main
    - develop
    - MB
# =============================================================================
# TEST STAGE
# =============================================================================

test_backend:
  stage: test
  image: node:18
  needs:
    - build_backend_image
  services:
    - postgres:16-alpine
  variables:
    POSTGRES_DB: test_fugue_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_pass
    DATABASE_URL: postgresql://test_user:test_pass@postgres:5432/test_fugue_db
    NODE_ENV: test
  before_script:
    - cd backend
    - npm install
  script:
    - echo "üß™ Running backend tests..."
    - npm test
    - echo "‚úÖ Backend tests completed"
  only:
    - main
    - develop
    - MB

test_frontend:
  stage: test
  image: node:18
  needs:
    - build_frontend_image
  before_script:
    - cd frontend
    - npm install
  script:
    - echo "üß™ Running frontend tests..."
    - npm test
    - echo "‚úÖ Frontend tests completed"
  only:
    - main
    - develop
    - MB

# =============================================================================
# DEPLOY STAGE
# =============================================================================

deploy_aws_staging:
  stage: deploy
  image: alpine:latest
  needs:
    - build_backend_image
    - build_frontend_image
    - test_backend
    - test_frontend
  before_script:
    - apk add --no-cache openssh-client rsync bash docker-cli curl
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$STAGING_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
  script:
    - echo "üöÄ Deploying Fugue app to AWS EC2 ($STAGING_HOST)..."
    
    # Copy docker-compose file to EC2
    - rsync -avz docker-compose.prod.yml "$STAGING_USER@$STAGING_HOST:$DEPLOY_DIR/docker-compose.yml"
    
    # Deploy to AWS EC2 instance
    - |
      ssh -o StrictHostKeyChecking=no "$STAGING_USER@$STAGING_HOST" \
        "cd $DEPLOY_DIR && \
         echo 'üîê Logging into GitLab Container Registry...' && \
         echo '$CI_REGISTRY_PASSWORD' | docker login -u '$CI_REGISTRY_USER' --password-stdin $CI_REGISTRY && \
         export FRONTEND_IMAGE='$FRONTEND_IMAGE:$IMAGE_TAG' && \
         export BACKEND_IMAGE='$BACKEND_IMAGE:$IMAGE_TAG' && \
         export POSTGRES_PASSWORD=\$POSTGRES_PASSWORD && \
         export SESSION_SECRET=\$JWT_SECRET && \
         echo 'üì• Pulling latest Docker images...' && \
         docker pull \$FRONTEND_IMAGE && \
         docker pull \$BACKEND_IMAGE && \
         echo 'üõë Stopping old containers...' && \
         docker-compose down --timeout 30 || true && \
         echo 'üöÄ Starting new containers...' && \
         docker-compose up -d && \
         echo '‚è≥ Waiting for services to start...' && \
         sleep 30 && \
         echo 'üîç Testing backend health...' && \
         curl -f http://localhost:8080/health && \
         echo '‚úÖ AWS EC2 deployment completed!'"
  environment:
    name: aws-staging
    url: http://$STAGING_HOST
  dependencies:
    - build_backend_image
    - build_frontend_image
  only:
    - develop
    - MB
  when: manual

deploy_aws_production:
  stage: deploy
  image: alpine:latest
  needs:
    - build_backend_image
    - build_frontend_image
    - test_backend
    - test_frontend
  before_script:
    - apk add --no-cache openssh-client rsync bash docker-cli curl
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$STAGING_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
  script:
    - echo "üöÄ Deploying Fugue app to AWS EC2 Production ($STAGING_HOST)..."
    
    # Copy docker-compose file to EC2
    - rsync -avz docker-compose.prod.yml "$STAGING_USER@$STAGING_HOST:$DEPLOY_DIR/docker-compose.yml"
    
    # Deploy to AWS EC2 production
    - |
      ssh -o StrictHostKeyChecking=no "$STAGING_USER@$STAGING_HOST" \
        "cd $DEPLOY_DIR && \
         echo 'üîß Preparing production deployment...' && \
         echo 'üîê Logging into GitLab Container Registry...' && \
         echo '$CI_REGISTRY_PASSWORD' | docker login -u '$CI_REGISTRY_USER' --password-stdin $CI_REGISTRY && \
         export FRONTEND_IMAGE='$FRONTEND_IMAGE:$IMAGE_TAG' && \
         export BACKEND_IMAGE='$BACKEND_IMAGE:$IMAGE_TAG' && \
         export POSTGRES_PASSWORD=\$POSTGRES_PASSWORD && \
         export SESSION_SECRET=\$JWT_SECRET && \
         echo 'üì• Pulling verified Docker images...' && \
         docker pull \$FRONTEND_IMAGE && \
         docker pull \$BACKEND_IMAGE && \
         echo 'üõë Gracefully stopping containers...' && \
         docker-compose down --timeout 30 || true && \
         echo 'üßπ Cleaning old Docker images...' && \
         docker image prune -f && \
         echo 'üöÄ Starting production containers...' && \
         docker-compose up -d && \
         echo '‚è≥ Waiting for services to be ready...' && \
         sleep 45 && \
         echo 'üîç Verifying production deployment...' && \
         curl -f http://localhost:8080/health && \
         echo 'üéâ AWS EC2 production deployment completed successfully!'"
  environment:
    name: aws-production
    url: http://$STAGING_HOST
  dependencies:
    - build_backend_image
    - build_frontend_image
  only:
    - main
  when: manual