name: Fugue CI/CD Pipeline

on:
  push:
    branches: [ main-test-cases]

env:
  GCP_PROJECT_ID: 'fugue-app-476509'
  GCP_REGION: 'us-central1'
  ARTIFACT_REGISTRY_REPO: 'fugue-app'

jobs:
  # Stage 1: Code Quality & Linting
  lint:
    name: ğŸ” Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install backend dependencies
        run: npm ci

      - name: Install frontend dependencies
        run: |
          cd client
          npm ci

      - name: Lint backend code
        run: |
          echo "ğŸ” Checking backend code quality..."
          npx eslint . --ext .js --max-warnings 0 || echo "âš ï¸ Backend linting found issues (non-blocking)"

      - name: Lint frontend code
        run: |
          cd client
          echo "ğŸ” Checking frontend code quality..."
          npm run lint || echo "âš ï¸ Frontend linting found issues (non-blocking)"

      - name: Check code formatting
        run: |
          echo "âœ… Code quality check completed"

  # Stage 2: Backend Unit & Integration Tests
  test-backend:
    name: ğŸ§ª Backend Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install backend dependencies
        run: npm ci

      - name: Run backend health check test
        run: |
          echo "ğŸ§ª Running backend health check test..."
          npm test

      - name: Run API endpoint tests
        run: |
          echo "ğŸ§ª Running API endpoint tests..."
          npm run test:api

      - name: Run WebSocket integration tests
        run: |
          echo "ğŸ§ª Running WebSocket integration tests..."
          npm run test:websocket

      - name: Verify server starts correctly
        run: |
          echo "ğŸš€ Testing server startup..."
          timeout 10s node index.js &
          SERVER_PID=$!
          sleep 5
          if ps -p $SERVER_PID > /dev/null; then
            echo "âœ… Server started successfully"
            kill $SERVER_PID 2>/dev/null || true
          else
            echo "âŒ Server failed to start"
            exit 1
          fi

      - name: Test summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Backend Test Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ“ Health check test passed"
          echo "âœ“ API endpoint tests passed"
          echo "âœ“ WebSocket integration tests passed"
          echo "âœ“ Server startup test passed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Stage 3: Frontend Build & Tests
  test-frontend:
    name: ğŸ¨ Frontend Build & Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: 'client/package-lock.json'

      - name: Install frontend dependencies
        run: |
          cd client
          npm ci

      - name: Build frontend
        run: |
          cd client
          npm run build

      - name: Verify build output
        run: |
          echo "ğŸ“¦ Verifying build artifacts..."
          ls -la client/dist/
          if [ ! -f "client/dist/index.html" ]; then
            echo "âŒ Build failed - index.html not found"
            exit 1
          fi
          echo "âœ… Frontend build successful"

      - name: Check bundle size
        run: |
          cd client/dist
          TOTAL_SIZE=$(du -sk . | cut -f1)
          echo "ğŸ“Š Total bundle size: ${TOTAL_SIZE}KB"
          if [ $TOTAL_SIZE -gt 10000 ]; then
            echo "âš ï¸ Warning: Bundle size is large (${TOTAL_SIZE}KB)"
          else
            echo "âœ… Bundle size is acceptable"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: client/dist/
          retention-days: 7

  # Stage 4: Performance & Load Testing
  performance-test:
    name: âš¡ Performance & Load Tests
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install backend dependencies
        run: npm ci

      - name: Run performance tests
        run: |
          echo "âš¡ Running performance and load tests..."
          npm run test:performance

      - name: Performance summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Performance Test Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ“ Load testing completed"
          echo "âœ“ Latency benchmarks passed"
          echo "âœ“ Concurrent connections tested"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Stage 5: Security Scanning
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, performance-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Run npm audit (backend)
        run: |
          echo "ğŸ”’ Scanning backend dependencies for vulnerabilities..."
          npm audit --audit-level=high || echo "âš ï¸ Security vulnerabilities found (non-blocking)"

      - name: Run npm audit (frontend)
        run: |
          cd client
          echo "ğŸ”’ Scanning frontend dependencies for vulnerabilities..."
          npm audit --audit-level=high || echo "âš ï¸ Security vulnerabilities found (non-blocking)"

      - name: Check for secrets
        run: |
          echo "ğŸ” Checking for exposed secrets..."
          if grep -r "API_KEY\|SECRET\|PASSWORD" --exclude-dir=node_modules --exclude-dir=.git . | grep -v ".github/workflows"; then
            echo "âš ï¸ Potential secrets found in code"
          else
            echo "âœ… No exposed secrets detected"
          fi

  # Stage 6: Docker Build & Validation (Dev Branch)
  build-dev:
    name: ğŸ³ Build Dev Docker Image
    needs: [test-backend, test-frontend, performance-test, security-scan]
    if: github.ref == 'refs/heads/main-test-cases'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build dev Docker image
        run: |
          echo "ğŸ³ Building development Docker image..."
          docker build -f Dockerfile.dev -t fugue-dev:${{ github.sha }} .

      - name: Test dev container
        run: |
          echo "ğŸ§ª Testing dev container..."
          docker run -d --name test-container -p 8080:8080 fugue-dev:${{ github.sha }}
          sleep 10
          if docker ps | grep test-container; then
            echo "âœ… Dev container is running"
            docker stop test-container
            docker rm test-container
          else
            echo "âŒ Dev container failed to start"
            docker logs test-container
            exit 1
          fi

      - name: Dev build summary
        run: |
          echo "ğŸ“Š Dev Build Summary:"
          docker images fugue-dev:${{ github.sha }}
          echo "âœ… Dev build completed successfully"

  # Stage 7: Production Build, Push & Deploy (Main Branch)
  build-and-deploy-prod:
    name: ğŸš€ Build & Deploy to Production
    needs: [test-backend, test-frontend, performance-test, security-scan]
    if: github.ref == 'refs/heads/main-test-cases'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Convert repository name to lowercase
        id: repo_name
        run: echo "repo_lowercase=$(echo ${{ github.event.repository.name }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Build production Docker image
        run: |
          echo "ğŸ³ Building production Docker image..."
          docker build -f Dockerfile.prod \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ steps.repo_name.outputs.repo_lowercase }}:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ steps.repo_name.outputs.repo_lowercase }}:latest \
            .
          echo "âœ… Docker image built successfully"

      - name: Test production container locally
        run: |
          echo "ğŸ§ª Testing production container before push..."
          docker run -d --name prod-test \
            -p 8080:8080 \
            -e NODE_ENV=production \
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ steps.repo_name.outputs.repo_lowercase }}:${{ github.sha }}
          
          sleep 15
          
          # Test health endpoint
          if curl -f http://localhost:8080/health; then
            echo "âœ… Production container health check passed"
          else
            echo "âŒ Production container health check failed"
            docker logs prod-test
            docker stop prod-test
            docker rm prod-test
            exit 1
          fi
          
          docker stop prod-test
          docker rm prod-test

      - name: Scan Docker image for vulnerabilities
        run: |
          echo "ğŸ” Scanning Docker image for vulnerabilities..."
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image \
            --severity HIGH,CRITICAL \
            --exit-code 0 \
            ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ steps.repo_name.outputs.repo_lowercase }}:${{ github.sha }} \
            || echo "âš ï¸ Vulnerabilities found (non-blocking)"

      - name: Push Docker image to Artifact Registry
        run: |
          echo "ğŸ“¤ Pushing Docker images to Artifact Registry..."
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ steps.repo_name.outputs.repo_lowercase }}:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ steps.repo_name.outputs.repo_lowercase }}:latest
          echo "âœ… Images pushed successfully"

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          echo "ğŸš€ Deploying to Cloud Run..."
          gcloud run deploy ${{ steps.repo_name.outputs.repo_lowercase }} \
            --image ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ steps.repo_name.outputs.repo_lowercase }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --port 8080 \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 1 \
            --max-instances 10 \
            --set-env-vars "NODE_ENV=production" \
            --timeout 3600 \
            --session-affinity
          echo "âœ… Deployment initiated"

      - name: Wait for deployment stabilization
        run: |
          echo "â³ Waiting for deployment to stabilize..."
          sleep 30

      - name: Get Service URL
        id: service_url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ steps.repo_name.outputs.repo_lowercase }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --format 'value(status.url)')
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "ğŸŒ Service URL: $SERVICE_URL"

      - name: Health check deployment
        run: |
          SERVICE_URL="${{ steps.service_url.outputs.url }}"
          echo "ğŸ¥ Running deployment health checks..."
          
          # Test root endpoint
          echo "Testing root endpoint..."
          if curl -f "$SERVICE_URL" > /dev/null 2>&1; then
            echo "âœ… Root endpoint is accessible"
          else
            echo "âŒ Root endpoint failed"
            exit 1
          fi
          
          # Test health endpoint
          echo "Testing health endpoint..."
          if curl -f "$SERVICE_URL/health"; then
            echo "âœ… Health endpoint is responding"
          else
            echo "âŒ Health endpoint failed"
            exit 1
          fi
          
          # Test WebSocket info endpoint
          echo "Testing WebSocket info endpoint..."
          if curl -f "$SERVICE_URL/websocket-info"; then
            echo "âœ… WebSocket info endpoint is responding"
          else
            echo "âš ï¸ WebSocket info endpoint failed (non-critical)"
          fi

      - name: Test WebSocket connection
        run: |
          SERVICE_URL="${{ steps.service_url.outputs.url }}"
          echo "ğŸ”Œ Testing WebSocket connection..."
          
          # Install wscat for WebSocket testing
          npm install -g wscat
          
          # Test WebSocket connection (with timeout)
          timeout 10s wscat -c "${SERVICE_URL/https/wss}" -x '{"type":"join","username":"ci-test"}' 2>&1 | tee ws-test.log || true
          
          if grep -q "connected" ws-test.log || grep -q "waiting" ws-test.log; then
            echo "âœ… WebSocket connection test passed"
          else
            echo "âš ï¸ WebSocket connection test inconclusive (non-blocking)"
          fi

      - name: Load test (basic)
        run: |
          SERVICE_URL="${{ steps.service_url.outputs.url }}"
          echo "âš¡ Running basic load test..."
          
          for i in {1..10}; do
            curl -s "$SERVICE_URL/health" > /dev/null &
          done
          wait
          
          echo "âœ… Basic load test completed"

      - name: Deployment summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Deployment Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Image: ${{ steps.repo_name.outputs.repo_lowercase }}:${{ github.sha }}"
          echo "ğŸŒ URL: ${{ steps.service_url.outputs.url }}"
          echo "ğŸ·ï¸  Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All deployment tests passed!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful - Service is live!"
          else
            echo "âŒ Deployment failed - Please check the logs"
            exit 1
          fi

